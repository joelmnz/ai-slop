<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Response Comparison</title>
    <!-- Include marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
    <!-- Include highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.3.1/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.3.1/highlight.min.js"></script>
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script>
        hljs.highlightAll();
    </script>
</head>
<body>

    <div class="container">
        <h1>LLM Response Comparison</h1>

        <div class="comparison-meta">
            <label for="comparisonTitle">Comparison Title:</label>
            <input type="text" id="comparisonTitle" placeholder="Enter a title for this comparison...">

            <label for="userPrompt">User Prompt:</label>
            <textarea id="userPrompt" rows="4" placeholder="Paste the prompt used to generate the responses..."></textarea>
            <div id="userPromptMarkdown" class="markdown-view"></div>
        </div>

        <div class="controls">
            <button id="newBtn"><i class="fas fa-file"></i> New Comparison</button>
            <button id="addColumnBtn"><i class="fas fa-plus-square"></i> Add Column</button>
            <button id="saveBtn"><i class="fas fa-save"></i> Save Comparison</button>
            <button id="toggleMarkdownBtn"><i class="fas fa-code"></i> Toggle Markdown</button>
            <button id="loadBtn"><i class="fas fa-file-upload"></i> Load Comparison</button>
            <input type="file" id="loadFile" accept=".json" style="display: none;"> <!-- Hidden file input -->
            <span id="statusMessage"></span> <!-- For feedback -->
        </div>

        <div id="comparisonColumns" class="columns-container">
            <!-- Columns will be populated by JS -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM References ---
            const newBtn = document.getElementById('newBtn'); // New Button Ref
            const addColumnBtn = document.getElementById('addColumnBtn');
            const saveBtn = document.getElementById('saveBtn');
            const toggleMarkdownBtn = document.getElementById('toggleMarkdownBtn');
            const loadBtn = document.getElementById('loadBtn');
            const loadFile = document.getElementById('loadFile');
            const columnsContainer = document.getElementById('comparisonColumns');
            const comparisonTitleInput = document.getElementById('comparisonTitle');
            const userPromptTextarea = document.getElementById('userPrompt');
            let userPromptMarkdown = document.getElementById('userPromptMarkdown');
            const statusMessageSpan = document.getElementById('statusMessage');

            // --- State ---
            let columnCounter = 0; // Initialize counter
            let markdownViewActive = false; // Track markdown view state

            // --- Configure marked options ---
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true,
                gfm: true
            });

            // --- Utility Functions ---
            function setStatus(message, type = 'info', duration = 3000) {
                statusMessageSpan.textContent = message;
                statusMessageSpan.className = type; // 'info', 'success', 'error'
                if (duration > 0) {
                    setTimeout(() => {
                        statusMessageSpan.textContent = '';
                        statusMessageSpan.className = '';
                    }, duration);
                }
            }

            // Toggle Markdown View Function
            function toggleMarkdownView() {
                markdownViewActive = !markdownViewActive;
                
                // Handle column responses
                const columns = columnsContainer.querySelectorAll('.column');
                columns.forEach(column => {
                    const textarea = column.querySelector('.llm-response-textarea');
                    let markdownView = column.querySelector('.markdown-view');
                    
                    // Create markdown view div if it doesn't exist
                    if (!markdownView) {
                        markdownView = document.createElement('div');
                        markdownView.classList.add('markdown-view');
                        
                        // Insert markdown view after textarea
                        textarea.insertAdjacentElement('afterend', markdownView);
                    }
                    
                    if (markdownViewActive) {
                        // Render markdown
                        markdownView.innerHTML = marked.parse(textarea.value);
                        
                        // Highlight code blocks
                        markdownView.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                        
                        // Show markdown view, hide textarea
                        textarea.style.display = 'none';
                        markdownView.style.display = 'block';
                    } else {
                        // Show textarea, hide markdown view
                        textarea.style.display = 'block';
                        markdownView.style.display = 'none';
                    }
                });
                
                // Handle user prompt - ensure the markdown element exists and is correctly populated
                if (markdownViewActive) {
                    // Always ensure userPromptMarkdown exists and is accessible
                    if (!userPromptMarkdown) {
                        userPromptMarkdown = document.getElementById('userPromptMarkdown');
                    }
                    
                    if (userPromptMarkdown) {
                        // Render markdown for user prompt
                        userPromptMarkdown.innerHTML = marked.parse(userPromptTextarea.value || '');
                        
                        // Highlight code blocks in user prompt
                        userPromptMarkdown.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                        
                        // Show markdown view, hide textarea for user prompt
                        userPromptTextarea.style.display = 'none';
                        userPromptMarkdown.style.display = 'block';
                    }
                } else {
                    // Show textarea, hide markdown view for user prompt
                    userPromptTextarea.style.display = 'block';
                    if (userPromptMarkdown) {
                        userPromptMarkdown.style.display = 'none';
                    }
                }
                
                // Update button text and icon
                if (markdownViewActive) {
                    toggleMarkdownBtn.innerHTML = '<i class="fas fa-font"></i> Show Raw Text';
                } else {
                    toggleMarkdownBtn.innerHTML = '<i class="fas fa-code"></i> Toggle Markdown';
                }
                
                setStatus(markdownViewActive ? 'Showing rendered markdown' : 'Showing raw text', 'info');
            }

            // --- Column Creation ---
            function createColumn(data = null) {
                columnCounter++; // Increment counter for unique IDs

                const columnDiv = document.createElement('div');
                columnDiv.classList.add('column');

                const modelNameLabel = document.createElement('label');
                modelNameLabel.classList.add('model-name-label');
                modelNameLabel.textContent = 'Model Name:';
                const modelNameId = `modelName${columnCounter}`;
                modelNameLabel.htmlFor = modelNameId;

                const modelNameInput = document.createElement('input');
                modelNameInput.type = 'text';
                modelNameInput.id = modelNameId;
                modelNameInput.classList.add('model-name-input');
                modelNameInput.placeholder = 'Model Name';
                if (data?.modelName) modelNameInput.value = data.modelName;

                const responseLabel = document.createElement('label');
                responseLabel.classList.add('llm-response-label');
                responseLabel.textContent = 'LLM Response:';
                const responseId = `llmResponse${columnCounter}`;
                responseLabel.htmlFor = responseId;

                const responseTextarea = document.createElement('textarea');
                responseTextarea.id = responseId;
                responseTextarea.classList.add('llm-response-textarea');
                responseTextarea.placeholder = 'Paste LLM response here...';
                if (data?.llmResponse) responseTextarea.value = data.llmResponse;
                
                // Create markdown view div but keep it hidden
                const markdownView = document.createElement('div');
                markdownView.classList.add('markdown-view');
                if (data?.llmResponse && markdownViewActive) {
                    markdownView.innerHTML = marked.parse(data.llmResponse);
                    markdownView.style.display = 'block';
                    responseTextarea.style.display = 'none';
                } else {
                    markdownView.style.display = 'none';
                }

                const ratingContainer = document.createElement('div');
                ratingContainer.classList.add('rating-container');

                const ratingLabel = document.createElement('label');
                ratingLabel.classList.add('rating-label');
                ratingLabel.textContent = 'Rating (1-5):';
                const ratingId = `rating${columnCounter}`;
                ratingLabel.htmlFor = ratingId;

                const ratingInput = document.createElement('input');
                ratingInput.type = 'number';
                ratingInput.id = ratingId;
                ratingInput.classList.add('rating-input');
                ratingInput.min = '1';
                ratingInput.max = '5';
                ratingInput.step = '1';
                ratingInput.placeholder = 'e.g., 3';
                 if (data?.rating) ratingInput.value = data.rating;

                ratingContainer.appendChild(ratingLabel);
                ratingContainer.appendChild(ratingInput);

                const removeBtn = document.createElement('button');
                removeBtn.classList.add('remove-column-btn');
                removeBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Remove Column';

                columnDiv.appendChild(modelNameLabel);
                columnDiv.appendChild(modelNameInput);
                columnDiv.appendChild(responseLabel);
                columnDiv.appendChild(responseTextarea);
                columnDiv.appendChild(markdownView);
                columnDiv.appendChild(ratingContainer);
                columnDiv.appendChild(removeBtn);

                return columnDiv;
            }

            // --- Setup Initial Columns ---
            // Sets placeholders and IDs for newly created default columns
            function setupInitialColumn(columnIndex, modelPlaceholder, ratingPlaceholder) {
                // Find the specific column element based on its index in the container
                const column = columnsContainer.children[columnIndex - 1];
                if (!column) return;

                const modelNameInput = column.querySelector('.model-name-input');
                const modelNameLabel = column.querySelector('.model-name-label');
                const responseTextarea = column.querySelector('.llm-response-textarea');
                const responseLabel = column.querySelector('.llm-response-label');
                const ratingInput = column.querySelector('.rating-input');
                const ratingLabel = column.querySelector('.rating-label');

                // IDs are already set by createColumn, just set placeholders
                if (modelNameInput) modelNameInput.placeholder = modelPlaceholder;
                if (ratingInput) ratingInput.placeholder = ratingPlaceholder;
            }


            // --- Reset Function ---
            function resetToDefaultState() {
                 // Clear metadata
                comparisonTitleInput.value = '';
                userPromptTextarea.value = '';

                // Clear existing columns
                columnsContainer.innerHTML = '';

                // Reset column counter
                columnCounter = 0;

                // Add two default columns
                const column1 = createColumn(); // Creates column with ID suffix 1
                const column2 = createColumn(); // Creates column with ID suffix 2
                columnsContainer.appendChild(column1);
                columnsContainer.appendChild(column2);

                // Setup placeholders for the new default columns
                setupInitialColumn(1, 'e.g., GPT-4', 'e.g., 4');
                setupInitialColumn(2, 'e.g., Claude 3', 'e.g., 5');

                setStatus('Comparison reset to default state.', 'info');
            }


            // --- Event Listeners ---

            // New Comparison
            newBtn.addEventListener('click', () => {
                // Optional: Add a confirmation dialog
                if (confirm('Are you sure you want to start a new comparison? All current data will be lost.')) {
                    resetToDefaultState();
                }
            });

            // Add Column
            addColumnBtn.addEventListener('click', () => {
                const newColumn = createColumn();
                columnsContainer.appendChild(newColumn);
                setStatus('New column added.', 'info');
            });

            // Remove Column (Event Delegation)
            columnsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('remove-column-btn')) {
                    const columnToRemove = event.target.closest('.column');
                    if (columnToRemove) {
                        columnToRemove.remove();
                        setStatus('Column removed.', 'info');
                        // Note: columnCounter is not decremented
                    }
                }
            });

            // Save Comparison
            saveBtn.addEventListener('click', () => {
                try {
                    const comparisonData = {
                        comparisonTitle: comparisonTitleInput.value || "Untitled Comparison",
                        userPrompt: userPromptTextarea.value || "",
                        responses: []
                    };

                    const columnElements = columnsContainer.querySelectorAll('.column');
                    columnElements.forEach(column => {
                        const modelName = column.querySelector('.model-name-input').value;
                        const llmResponse = column.querySelector('.llm-response-textarea').value;
                        const ratingValue = column.querySelector('.rating-input').value;
                        const rating = ratingValue ? parseInt(ratingValue, 10) : null;

                        comparisonData.responses.push({
                            modelName: modelName || "Unnamed Model",
                            llmResponse: llmResponse || "",
                            rating: (rating >= 1 && rating <= 5) ? rating : null
                        });
                    });

                    const jsonString = JSON.stringify(comparisonData, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    // Generate default filename from the comparison title
                    const safeTitle = comparisonData.comparisonTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    const defaultFilename = `${safeTitle || 'llm_comparison'}`;
                    
                    // Prompt user for filename
                    const userFilename = prompt("Enter filename for saving (without extension):", defaultFilename);
                    
                    // If user cancels the prompt, abort the save
                    if (userFilename === null) {
                        URL.revokeObjectURL(url);
                        return;
                    }
                    
                    // Use user's filename or default if empty, and sanitize
                    const finalFilename = (userFilename.trim() || defaultFilename).replace(/[^a-z0-9]/gi, '_').toLowerCase();

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${finalFilename}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    setStatus('Comparison saved successfully!', 'success');

                } catch (error) {
                    console.error("Error saving comparison:", error);
                    setStatus(`Error saving file: ${error.message}`, 'error', 5000);
                }
            });

            // Load Comparison - Trigger File Input
            loadBtn.addEventListener('click', () => {
                loadFile.click();
            });

            // Load Comparison - Handle File Selection
            loadFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();

                reader.onload = (e) => {
                    const content = e.target.result;
                    let loadedData;

                    try {
                        loadedData = JSON.parse(content);
                    } catch (error) {
                        console.error("Error parsing JSON:", error);
                        setStatus(`Error: Could not parse file. Ensure it's valid JSON. (${error.message})`, 'error', 5000);
                        loadFile.value = null;
                        return;
                    }

                    if (typeof loadedData !== 'object' || loadedData === null ||
                        typeof loadedData.comparisonTitle === 'undefined' ||
                        typeof loadedData.userPrompt === 'undefined' ||
                        !Array.isArray(loadedData.responses))
                    {
                        setStatus('Error: Invalid file format. Missing required fields.', 'error', 5000);
                        loadFile.value = null;
                        return;
                    }

                    try {
                        // Clear existing content and reset counter before loading
                        columnsContainer.innerHTML = '';
                        columnCounter = 0; // Reset counter is crucial here

                        comparisonTitleInput.value = loadedData.comparisonTitle || "";
                        userPromptTextarea.value = loadedData.userPrompt || "";

                        if (loadedData.responses.length === 0) {
                             setStatus('Loaded comparison has no responses.', 'info');
                             // If no responses, add the two default columns
                             resetToDefaultState(); // Or just add two empty columns? Resetting seems safer.
                             comparisonTitleInput.value = loadedData.comparisonTitle || ""; // Re-apply meta after reset
                             userPromptTextarea.value = loadedData.userPrompt || "";
                        } else {
                            loadedData.responses.forEach(response => {
                                if (typeof response === 'object' && response !== null) {
                                    const newColumn = createColumn(response);
                                    columnsContainer.appendChild(newColumn);
                                } else {
                                    console.warn("Skipping invalid response item during load:", response);
                                }
                            });
                             setStatus(`Comparison loaded successfully with ${loadedData.responses.length} response(s).`, 'success');
                        }

                    } catch (error) {
                         console.error("Error populating page from loaded data:", error);
                         setStatus(`Error applying loaded data: ${error.message}`, 'error', 5000);
                    } finally {
                         loadFile.value = null;
                    }
                };

                reader.onerror = (e) => {
                    console.error("Error reading file:", e);
                    setStatus(`Error reading file: ${reader.error}`, 'error', 5000);
                    loadFile.value = null;
                };

                reader.readAsText(file);
            });

            // Toggle Markdown View
            toggleMarkdownBtn.addEventListener('click', toggleMarkdownView);
            
            // Update markdown view when response textarea or user prompt changes
            document.addEventListener('input', (event) => {
                if (markdownViewActive) {
                    if (event.target.classList.contains('llm-response-textarea')) {
                        const column = event.target.closest('.column');
                        const markdownView = column.querySelector('.markdown-view');
                        
                        markdownView.innerHTML = marked.parse(event.target.value);
                        markdownView.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    } else if (event.target === userPromptTextarea) {
                        userPromptMarkdown.innerHTML = marked.parse(userPromptTextarea.value);
                        userPromptMarkdown.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });

            // --- Initial Page Load ---
            resetToDefaultState(); // Initialize the page with the default state
            
            // Ensure the userPromptMarkdown element is properly initialized
            if (!userPromptMarkdown) {
                userPromptMarkdown = document.getElementById('userPromptMarkdown');
            }
            if (userPromptMarkdown) {
                userPromptMarkdown.style.display = 'none';
            }
        });
    </script>

</body>
</html>